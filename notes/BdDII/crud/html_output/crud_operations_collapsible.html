<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>crud_operations</title>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #f8f8f8; }
.highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666 } /* Operator */
.highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #9C6500 } /* Comment.Preproc */
.highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #E40000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #008400 } /* Generic.Inserted */
.highlight .go { color: #717171 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #04D } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #687822 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #00F; font-weight: bold } /* Name.Class */
.highlight .no { color: #800 } /* Name.Constant */
.highlight .nd { color: #A2F } /* Name.Decorator */
.highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #00F } /* Name.Function */
.highlight .nl { color: #767600 } /* Name.Label */
.highlight .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.highlight .w { color: #BBB } /* Text.Whitespace */
.highlight .mb { color: #666 } /* Literal.Number.Bin */
.highlight .mf { color: #666 } /* Literal.Number.Float */
.highlight .mh { color: #666 } /* Literal.Number.Hex */
.highlight .mi { color: #666 } /* Literal.Number.Integer */
.highlight .mo { color: #666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #A45A77 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #00F } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666 } /* Literal.Number.Integer.Long */
    </style>
<style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0 auto; padding: 20px; }
        .main-title-block { background-color: #2e2e2e; color: #f0f0f0; padding: 18px; border-radius: 10px; border: 1px solid #444; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 1.8em; font-weight: bold; margin-bottom: 20px; text-align: center; }
        pre:not(.highlight pre) { background-color: #fef6e4; color: #2e2e2e; padding: 12px; border-radius: 5px; overflow-x: auto; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin: 15px 0; }
        code { font-family: "Courier New", Courier, monospace; }
        .highlight { padding: 0; border-radius: 5px; margin: 15px 0; background-color: #fef6e4 !important; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .highlight pre { background: none; border: none; box-shadow: none; padding: 12px; margin: 0; border-radius: 0; }
        .highlight .c, .highlight .c1, .highlight .cm { color: #9a8052 !important; font-style: italic; }
        .highlight .k, .highlight .kd, .highlight .kn { color: #8250df !important; font-weight: normal; }
        .highlight .s, .highlight .s1, .highlight .s2, .highlight .sb, .highlight .si { color: #327d41 !important; }
        .highlight .m, .highlight .mi, .highlight .mf { color: #606060 !important; }
        .highlight .o, .highlight .ow { color: #666666 !important; font-weight: normal; }
        .highlight .kc, .highlight .no { color: #9a5b13 !important; }
        .highlight .nf, .highlight .nb, .highlight .nx { color: #606060 !important; font-weight: normal; }
        .highlight .p { color: #666666 !important; font-weight: normal; }
        .language-jsx .highlight .k, .language-jsx .highlight .kd, .language-jsx .highlight .kr { color: #af00db !important; font-weight: normal; background: none !important; border: none !important; }
        .language-jsx .highlight .nx, .language-jsx .highlight .nf { color: #0969da !important; background: none !important; border: none !important; }
        .language-jsx .highlight .nt { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-jsx .highlight .nc { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-jsx .highlight .o  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-jsx .highlight .p  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-jsx .highlight .na { color: #0969da !important; background: none !important; border: none !important; }
        .language-jsx .highlight .s, .language-jsx .highlight .s1, .language-jsx .highlight .s2 { color: #0a3069 !important; background: none !important; border: none !important; }
        .language-jsx .highlight .c, .language-jsx .highlight .c1, .language-jsx .highlight .cm { color: #656d76 !important; font-style: italic; background: none !important; border: none !important; }
        .language-jsx .highlight .m, .language-jsx .highlight .mi, .language-jsx .highlight .mf { color: #0969da !important; background: none !important; border: none !important; }
        .language-react .highlight .k, .language-react .highlight .kd, .language-react .highlight .kr { color: #af00db !important; font-weight: normal; background: none !important; border: none !important; }
        .language-react .highlight .nx, .language-react .highlight .nf { color: #0969da !important; background: none !important; border: none !important; }
        .language-react .highlight .nt { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-react .highlight .nc { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-react .highlight .o  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-react .highlight .p  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-react .highlight .na { color: #0969da !important; background: none !important; border: none !important; }
        .language-react .highlight .s, .language-react .highlight .s1, .language-react .highlight .s2 { color: #0a3069 !important; background: none !important; border: none !important; }
        .language-react .highlight .c, .language-react .highlight .c1, .language-react .highlight .cm { color: #656d76 !important; font-style: italic; background: none !important; border: none !important; }
        .language-react .highlight .m, .language-react .highlight .mi, .language-react .highlight .mf { color: #0969da !important; background: none !important; border: none !important; }
        .language-tsx .highlight .k, .language-tsx .highlight .kd, .language-tsx .highlight .kr { color: #af00db !important; font-weight: normal; background: none !important; border: none !important; }
        .language-tsx .highlight .nx, .language-tsx .highlight .nf { color: #0969da !important; background: none !important; border: none !important; }
        .language-tsx .highlight .nt { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-tsx .highlight .nc { color: #116329 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-tsx .highlight .o  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-tsx .highlight .p  { color: #666666 !important; background:none !important; border:none !important; box-shadow:none !important; outline:none !important; }
        .language-tsx .highlight .na { color: #0969da !important; background: none !important; border: none !important; }
        .language-tsx .highlight .s, .language-tsx .highlight .s1, .language-tsx .highlight .s2 { color: #0a3069 !important; background: none !important; border: none !important; }
        .language-tsx .highlight .c, .language-tsx .highlight .c1, .language-tsx .highlight .cm { color: #656d76 !important; font-style: italic; background: none !important; border: none !important; }
        .language-tsx .highlight .m, .language-tsx .highlight .mi, .language-tsx .highlight .mf { color: #0969da !important; background: none !important; border: none !important; }
        .language-tsx .highlight .kt { color: #0969da !important; background: none !important; border: none !important; }
        .language-javascript .highlight .err { color: #116329 !important; background: none !important; border: none !important; }
        .language-js .highlight .err { color: #116329 !important; background: none !important; border: none !important; }
        .highlight span { background: none !important; border: none !important; box-shadow: none !important; text-decoration: none !important; outline: none !important; }
        .empty-code-block { background-color: #fef6e4; color: #2e2e2e; padding: 12px; border-radius: 5px; margin: 15px 0; font-family: monospace; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .highlight-error { background-color: #fef6e4; color: #000080; padding: 12px; border-radius: 5px; margin: 15px 0; font-family: monospace; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        img { max-width: 100%; height: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
        .chapter-container { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chapter-container h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #444; }
    </style>
<style>
        /* CSS from sintax.css */
/* custom-code-style-complete.css */
/* Estilos completos para ajustar el contraste y usar tonos de gris en el resaltado de sintaxis */
h1 {
    background-color: #4b0404;
    color: #e38735;
    padding: 18px;
    border-radius: 10px;
    border: 1px solid #444;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}

    </style>
<style id="collapsible-styles">
/* Estilos para el contenedor colapsable */
.collapsible-container {
  position: relative;
  overflow: hidden;
  transition: max-height 0.3s ease;
  border-radius: 8px;
  margin: 0;
}
.collapsible-container pre {
  margin: 0;
  line-height: 1.4; /* Forzar line-height consistente */
}
.collapsible-container .toggle-button {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(255,255,255,0.9);
  border: 1px solid #ccc;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
  padding: 4px 8px;
  border-radius: 4px;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.collapsible-container .toggle-button:hover {
  background: rgba(255,255,255,1);
}
.collapsible-container .fade-overlay {
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 42px;
  background: linear-gradient(
    to bottom, 
    rgba(255,249,229,0), 
    rgba(255,249,229,1)
  );
  pointer-events: none;
  z-index: 5;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
.collapsible-container .ellipsis {
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
  color: #888;
  font-size: 18px;
  font-weight: bold;
  z-index: 6;
}
.collapsible-container.expanded .fade-overlay,
.collapsible-container.expanded .ellipsis {
  display: none;
}
</style><script>(function() {
  function initCollapsibles() {
    // Esperar un poco para que los estilos se apliquen
    setTimeout(() => {
      document.querySelectorAll('.collapsible-container').forEach(container => {
        const pre = container.querySelector('pre');
        if (!pre) return;
        
        const maxLines = parseInt(container.dataset.maxLines, 10) || 6;
        
        // Crear un elemento temporal para medir line-height
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.fontSize = getComputedStyle(pre).fontSize;
        tempSpan.style.fontFamily = getComputedStyle(pre).fontFamily;
        tempSpan.style.lineHeight = '1.4';
        tempSpan.textContent = 'M';
        document.body.appendChild(tempSpan);
        
        const lineHeight = tempSpan.offsetHeight;
        document.body.removeChild(tempSpan);
        
        const fullHeight = pre.scrollHeight;
        const collapsedHeight = Math.ceil(lineHeight * maxLines);
        
        console.log('Debug:', {
          maxLines,
          lineHeight,
          fullHeight,
          collapsedHeight,
          shouldCollapse: fullHeight > collapsedHeight + 10
        });
        
        // Solo colapsar si realmente es necesario
        if (fullHeight <= collapsedHeight + 10) {
          return;
        }

        // Estado inicial: colapsado
        container.style.maxHeight = collapsedHeight + 'px';
        container.classList.add('collapsed');

        // Crear botón
        const btn = document.createElement('button');
        btn.className = 'toggle-button';
        btn.textContent = '+';
        btn.title = 'Expandir/Colapsar código';
        container.appendChild(btn);

        // Crear overlay y ellipsis
        const overlay = document.createElement('div');
        overlay.className = 'fade-overlay';
        container.appendChild(overlay);
        
        const ell = document.createElement('div');
        ell.className = 'ellipsis';
        ell.textContent = '...';
        container.appendChild(ell);

        // Evento toggle
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const isCollapsed = container.classList.contains('collapsed');
          
          if (isCollapsed) {
            // Expandir
            container.style.maxHeight = fullHeight + 20 + 'px';
            container.classList.remove('collapsed');
            container.classList.add('expanded');
            btn.textContent = '−';
          } else {
            // Colapsar
            container.style.maxHeight = collapsedHeight + 'px';
            container.classList.add('collapsed');
            container.classList.remove('expanded');
            btn.textContent = '+';
          }
        });
      });
    }, 100); // Esperar 100ms para que se apliquen los estilos
  }
  
  // Múltiples puntos de inicialización para mayor compatibilidad
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollapsibles);
  } else {
    initCollapsibles();
  }
  
  // También inicializar en window.load por si acaso
  window.addEventListener('load', initCollapsibles);
})();</script></head>
<body>
<h1 id="ejemplos-completos-de-crud-en-mongodb-con-pymongo">Ejemplos Completos de CRUD en MongoDB con PyMongo</h1>
<p>Este documento complementa las notas sobre operaciones de actualización, proporcionando ejemplos completos para las operaciones CRUD (Create, Read, Update, Delete) en MongoDB utilizando PyMongo.</p>
<div class="chapter-container"><h2 id="configuracion-inicial-de-pymongo">Configuración Inicial de PyMongo</h2>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pymongo</span><span class="w"> </span><span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bson.objectid</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>

<span class="c1"># Conectar al servidor MongoDB</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">'mongodb://localhost:27017/'</span><span class="p">)</span>
<span class="c1"># Seleccionar la base de datos</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">'mi_restaurante'</span><span class="p">]</span>
<span class="c1"># Seleccionar la colección</span>
<span class="n">restaurante</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">restaurante</span>

<span class="c1"># Para imprimir documentos de forma legible</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div></div>
</div><div class="chapter-container"><h2 id="ejemplo-de-crud-para-un-sistema-de-gestion-de-restaurante">Ejemplo de CRUD para un Sistema de Gestión de Restaurante</h2>
<p>Trabajaremos con una colección llamada <code>restaurante</code> que gestiona información sobre platos del menú.</p>
<h3 id="1-create-crear">1. Create (Crear)</h3>
<p>PyMongo ofrece dos métodos principales para insertar documentos:</p>
<h4 id="insert_one">insert_one()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Insertar un plato al menú</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
    <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Paella Valenciana'</span><span class="p">,</span>
    <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Platos principales'</span><span class="p">,</span>
    <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">15.50</span><span class="p">,</span>
    <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'arroz'</span><span class="p">,</span> <span class="s1">'azafrán'</span><span class="p">,</span> <span class="s1">'pollo'</span><span class="p">,</span> <span class="s1">'conejo'</span><span class="p">,</span> <span class="s1">'judías verdes'</span><span class="p">,</span> <span class="s1">'garrofón'</span><span class="p">],</span>
    <span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'gluten'</span><span class="p">],</span>
    <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">'calorias'</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>
    <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">'fecha_creacion'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="p">})</span>

<span class="c1"># Obtener el ID del documento insertado</span>
<span class="n">id_paella</span> <span class="o">=</span> <span class="n">resultado</span><span class="o">.</span><span class="n">inserted_id</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plato insertado con ID: </span><span class="si">{</span><span class="n">id_paella</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h4 id="insert_many">insert_many()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Insertar varios platos al menú</span>
<span class="n">resultados</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">insert_many</span><span class="p">([</span>
    <span class="p">{</span>
        <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Gazpacho'</span><span class="p">,</span>
        <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Entrantes'</span><span class="p">,</span>
        <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">6.75</span><span class="p">,</span>
        <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'tomate'</span><span class="p">,</span> <span class="s1">'pimiento'</span><span class="p">,</span> <span class="s1">'pepino'</span><span class="p">,</span> <span class="s1">'ajo'</span><span class="p">,</span> <span class="s1">'aceite'</span><span class="p">,</span> <span class="s1">'vinagre'</span><span class="p">],</span>
        <span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">'calorias'</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
        <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'usuario'</span><span class="p">:</span> <span class="s1">'cliente1'</span><span class="p">,</span> <span class="s1">'puntuacion'</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span> <span class="s1">'comentario'</span><span class="p">:</span> <span class="s1">'Muy refrescante'</span><span class="p">}],</span>
        <span class="s1">'fecha_creacion'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Flan de vainilla'</span><span class="p">,</span>
        <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Postres'</span><span class="p">,</span>
        <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">4.25</span><span class="p">,</span>
        <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'huevo'</span><span class="p">,</span> <span class="s1">'leche'</span><span class="p">,</span> <span class="s1">'azúcar'</span><span class="p">,</span> <span class="s1">'vainilla'</span><span class="p">],</span>
        <span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'huevo'</span><span class="p">,</span> <span class="s1">'lactosa'</span><span class="p">],</span>
        <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">'calorias'</span><span class="p">:</span> <span class="mi">280</span><span class="p">,</span>
        <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'fecha_creacion'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">])</span>

<span class="c1"># Obtener los IDs de los documentos insertados</span>
<span class="n">ids_platos</span> <span class="o">=</span> <span class="n">resultados</span><span class="o">.</span><span class="n">inserted_ids</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Se insertaron </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_platos</span><span class="p">)</span><span class="si">}</span><span class="s2"> platos con IDs: </span><span class="si">{</span><span class="n">ids_platos</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h3 id="2-read-leer">2. Read (Leer)</h3>
<p>PyMongo proporciona varios métodos para consultar documentos:</p>
<h4 id="find_one">find_one()</h4>
<div class="highlight language-python"><pre><span></span><span class="c1"># Buscar un plato específico</span>
<span class="n">paella</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Paella Valenciana'</span><span class="p">})</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">paella</span><span class="p">)</span>
</pre></div>
<h4 id="find">find()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Obtener todos los entrantes</span>
<span class="n">entrantes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Entrantes'</span><span class="p">}))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Se encontraron </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entrantes</span><span class="p">)</span><span class="si">}</span><span class="s2"> entrantes:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">entrante</span> <span class="ow">in</span> <span class="n">entrantes</span><span class="p">:</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">entrante</span><span class="p">)</span>

<span class="c1"># Buscar platos sin gluten y con precio menor a 10€</span>
<span class="n">opciones_economicas_sin_gluten</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
    <span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$nin'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'gluten'</span><span class="p">]},</span>
    <span class="s1">'precio'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$lt'</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="p">}))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Opciones económicas sin gluten: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">opciones_economicas_sin_gluten</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">plato</span> <span class="ow">in</span> <span class="n">opciones_economicas_sin_gluten</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">plato</span><span class="p">[</span><span class="s1">'nombre'</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">plato</span><span class="p">[</span><span class="s1">'precio'</span><span class="p">]</span><span class="si">}</span><span class="s2">€"</span><span class="p">)</span>

<span class="c1"># Buscar platos con ciertos ingredientes, ordenados por calorías</span>
<span class="n">platos_con_tomate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'ingredientes'</span><span class="p">:</span> <span class="s1">'tomate'</span><span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">'calorias'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 1 para ascendente, -1 para descendente</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Platos con tomate ordenados por calorías:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">plato</span> <span class="ow">in</span> <span class="n">platos_con_tomate</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">plato</span><span class="p">[</span><span class="s1">'nombre'</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">plato</span><span class="p">[</span><span class="s1">'calorias'</span><span class="p">]</span><span class="si">}</span><span class="s2"> calorías"</span><span class="p">)</span>

<span class="c1"># Proyección: obtener solo nombre y precio</span>
<span class="n">menu_simplificado</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'precio'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'_id'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Menú simplificado:"</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">menu_simplificado</span><span class="p">)</span>

<span class="c1"># Paginación: obtener 5 platos, saltando los primeros 5</span>
<span class="n">segunda_pagina</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Segunda página del menú:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">plato</span> <span class="ow">in</span> <span class="n">segunda_pagina</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">plato</span><span class="p">[</span><span class="s1">'nombre'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h3 id="3-update-actualizar">3. Update (Actualizar)</h3>
<p>Como ya has detallado en tus notas, aquí te muestro algunos ejemplos prácticos adicionales:</p>
<h4 id="update_one">update_one()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Actualizar el precio de un plato</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Paella Valenciana'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$set'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'precio'</span><span class="p">:</span> <span class="mf">16.75</span><span class="p">}}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos encontrados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">matched_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos modificados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Añadir una valoración a un plato</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Paella Valenciana'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$push'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'usuario'</span><span class="p">:</span> <span class="s1">'cliente2'</span><span class="p">,</span>
            <span class="s1">'puntuacion'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">'comentario'</span><span class="p">:</span> <span class="s1">'Auténtica y deliciosa'</span>
        <span class="p">}</span>
    <span class="p">}}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Valoración añadida: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Actualizar documentos anidados con notación de punto</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'valoraciones.usuario'</span><span class="p">:</span> <span class="s1">'cliente1'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$set'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'valoraciones.$.puntuacion'</span><span class="p">:</span> <span class="mf">4.7</span><span class="p">}}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Valoración actualizada: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h4 id="update_many">update_many()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Incrementar el precio de todos los postres en un 5%</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Postres'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$mul'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'precio'</span><span class="p">:</span> <span class="mf">1.05</span><span class="p">}}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Postres actualizados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Marcar como no disponibles todos los platos con alérgenos específicos</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$in'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'frutos secos'</span><span class="p">,</span> <span class="s1">'mariscos'</span><span class="p">]}},</span>
    <span class="p">{</span><span class="s1">'$set'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Platos marcados como no disponibles: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h4 id="replace_one">replace_one()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Reemplazar completamente un plato</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Flan de vainilla'</span><span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Flan casero'</span><span class="p">,</span>
        <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Postres'</span><span class="p">,</span>
        <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">4.50</span><span class="p">,</span>
        <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'huevo'</span><span class="p">,</span> <span class="s1">'leche'</span><span class="p">,</span> <span class="s1">'azúcar'</span><span class="p">,</span> <span class="s1">'canela'</span><span class="p">],</span>
        <span class="s1">'alergenos'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'huevo'</span><span class="p">,</span> <span class="s1">'lactosa'</span><span class="p">],</span>
        <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">'calorias'</span><span class="p">:</span> <span class="mi">295</span><span class="p">,</span>
        <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">'fecha_creacion'</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="s1">'receta_actualizada'</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plato reemplazado: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h4 id="find_one_and_update">find_one_and_update()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Actualizar y devolver el documento actualizado</span>
<span class="n">plato_actualizado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Gazpacho'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$inc'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'precio'</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}},</span>
    <span class="n">return_document</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Devuelve el documento después de la actualización</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Plato actualizado:"</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">plato_actualizado</span><span class="p">)</span>
</pre></div></div>
<h3 id="4-delete-eliminar">4. Delete (Eliminar)</h3>
<p>PyMongo ofrece métodos para eliminar documentos:</p>
<h4 id="delete_one">delete_one()</h4>
<div class="highlight language-python"><pre><span></span><span class="c1"># Eliminar un plato del menú</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Gazpacho'</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos eliminados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<h4 id="delete_many">delete_many()</h4>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Eliminar todos los platos no disponibles</span>
<span class="n">resultado_multiple</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos eliminados: </span><span class="si">{</span><span class="n">resultado_multiple</span><span class="o">.</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Eliminar platos con 0 valoraciones y alta cantidad de calorías</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span>
    <span class="s1">'valoraciones'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$size'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="s1">'calorias'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$gt'</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Platos eliminados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h4 id="find_one_and_delete">find_one_and_delete()</h4>
<div class="highlight language-python"><pre><span></span><span class="c1"># Eliminar y devolver el plato eliminado</span>
<span class="n">plato_eliminado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">find_one_and_delete</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Flan casero'</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Plato eliminado:"</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">plato_eliminado</span><span class="p">)</span>
</pre></div>
</div><div class="chapter-container"><h2 id="operaciones-crud-avanzadas">Operaciones CRUD Avanzadas</h2>
<h3 id="uso-de-transacciones-para-operaciones-multiples">Uso de transacciones para operaciones múltiples</h3>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Iniciar una sesión</span>
<span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="c1"># Iniciar una transacción</span>
    <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Crear un nuevo plato</span>
            <span class="n">db</span><span class="o">.</span><span class="n">restaurante</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Arroz negro'</span><span class="p">,</span>
                <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Platos principales'</span><span class="p">,</span>
                <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">14.50</span><span class="p">,</span>
                <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'arroz'</span><span class="p">,</span> <span class="s1">'sepia'</span><span class="p">,</span> <span class="s1">'tinta de calamar'</span><span class="p">,</span> <span class="s1">'pimientos'</span><span class="p">],</span>
                <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">},</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

            <span class="c1"># Actualizar precios en la misma transacción</span>
            <span class="n">db</span><span class="o">.</span><span class="n">restaurante</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Platos principales'</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">'$inc'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'precio'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}},</span>
                <span class="n">session</span><span class="o">=</span><span class="n">session</span>
            <span class="p">)</span>

            <span class="c1"># Si todo va bien, la transacción se confirma automáticamente</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Transacción completada con éxito"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Si hay algún error, la transacción se aborta automáticamente</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error en la transacción: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="c1"># La excepción se propagará y abortará la transacción</span>
</pre></div></div>
<h3 id="operaciones-con-bulk_write">Operaciones con bulk_write()</h3>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pymongo</span><span class="w"> </span><span class="kn">import</span> <span class="n">InsertOne</span><span class="p">,</span> <span class="n">UpdateOne</span><span class="p">,</span> <span class="n">DeleteMany</span>

<span class="c1"># Preparar operaciones de bulk</span>
<span class="n">operaciones</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Insertar un nuevo plato</span>
    <span class="n">InsertOne</span><span class="p">({</span>
        <span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Tortilla española'</span><span class="p">,</span>
        <span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Entrantes'</span><span class="p">,</span>
        <span class="s1">'precio'</span><span class="p">:</span> <span class="mf">5.50</span><span class="p">,</span>
        <span class="s1">'ingredientes'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'huevo'</span><span class="p">,</span> <span class="s1">'patata'</span><span class="p">,</span> <span class="s1">'cebolla'</span><span class="p">,</span> <span class="s1">'aceite'</span><span class="p">],</span>
        <span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}),</span>
    <span class="c1"># Actualizar un plato existente</span>
    <span class="n">UpdateOne</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">'nombre'</span><span class="p">:</span> <span class="s1">'Paella Valenciana'</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">'$set'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'destacado'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
    <span class="p">),</span>
    <span class="c1"># Eliminar platos</span>
    <span class="n">DeleteMany</span><span class="p">({</span><span class="s1">'categoria'</span><span class="p">:</span> <span class="s1">'Fuera de temporada'</span><span class="p">})</span>
<span class="p">]</span>

<span class="c1"># Realizar múltiples operaciones en una sola llamada</span>
<span class="n">resultado</span> <span class="o">=</span> <span class="n">restaurante</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">operaciones</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Resultado de operaciones bulk_write:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos insertados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">inserted_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos modificados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">modified_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Documentos eliminados: </span><span class="si">{</span><span class="n">resultado</span><span class="o">.</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div></div>
<h3 id="consultas-con-agregacion">Consultas con agregación</h3>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span><span class="c1"># Obtener estadísticas de platos por categoría</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'$match'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'disponible'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
    <span class="p">{</span><span class="s1">'$group'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'_id'</span><span class="p">:</span> <span class="s1">'$categoria'</span><span class="p">,</span>
        <span class="s1">'numeroPlatos'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$sum'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s1">'precioPromedio'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$avg'</span><span class="p">:</span> <span class="s1">'$precio'</span><span class="p">},</span>
        <span class="s1">'caloriasTotales'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$sum'</span><span class="p">:</span> <span class="s1">'$calorias'</span><span class="p">}</span>
    <span class="p">}},</span>
    <span class="p">{</span><span class="s1">'$sort'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'numeroPlatos'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}}</span>
<span class="p">]</span>

<span class="n">estadisticas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Estadísticas por categoría:"</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">estadisticas</span><span class="p">)</span>

<span class="c1"># Obtener los platos mejor valorados</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'$match'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'valoraciones.0'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$exists'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}},</span>  <span class="c1"># Platos con al menos una valoración</span>
    <span class="p">{</span><span class="s1">'$addFields'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'valoracionPromedio'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$avg'</span><span class="p">:</span> <span class="s1">'$valoraciones.puntuacion'</span><span class="p">}</span>
    <span class="p">}},</span>
    <span class="p">{</span><span class="s1">'$sort'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'valoracionPromedio'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
    <span class="p">{</span><span class="s1">'$limit'</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'$project'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'nombre'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'categoria'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'precio'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'valoracionPromedio'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'numeroValoraciones'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'$size'</span><span class="p">:</span> <span class="s1">'$valoraciones'</span><span class="p">},</span>
        <span class="s1">'_id'</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}}</span>
<span class="p">]</span>

<span class="n">mejores_platos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restaurante</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Top 5 platos mejor valorados:"</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">mejores_platos</span><span class="p">)</span>
</pre></div></div>
</div><div class="chapter-container"><h2 id="buenas-practicas-para-operaciones-crud-con-pymongo">Buenas Prácticas para Operaciones CRUD con PyMongo</h2>
<ol>
<li><strong>Atomicidad</strong>: Utilizar operadores atómicos como <code>$set</code>, <code>$inc</code>, etc., en lugar de leer-modificar-escribir.</li>
<li>
<p><strong>Indexación</strong>: Crear índices para campos frecuentemente consultados para mejorar el rendimiento.
 <br/>
<div class="highlight language-python"><pre><span></span>   <span class="n">restaurante</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s1">'nombre'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
   <span class="n">restaurante</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s1">'categoria'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">'precio'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

</pre></div>
</p>
</li>
<li>
<p><strong>Validación</strong>: Usar esquemas de validación para asegurar la integridad de los datos.
 <br/>
<div class="highlight language-python"><div class="collapsible-container" data-max-lines="6"><pre><span></span>   <span class="n">db</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span><span class="s1">'restaurante'</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="p">{</span>
       <span class="s1">'$jsonSchema'</span><span class="p">:</span> <span class="p">{</span>
           <span class="s1">'bsonType'</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
           <span class="s1">'required'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'nombre'</span><span class="p">,</span> <span class="s1">'categoria'</span><span class="p">,</span> <span class="s1">'precio'</span><span class="p">],</span>
           <span class="s1">'properties'</span><span class="p">:</span> <span class="p">{</span>
               <span class="s1">'nombre'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'bsonType'</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
               <span class="s1">'categoria'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'bsonType'</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
               <span class="s1">'precio'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'bsonType'</span><span class="p">:</span> <span class="s1">'double'</span><span class="p">,</span> <span class="s1">'minimum'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
           <span class="p">}</span>
       <span class="p">}</span>
   <span class="p">})</span>

</pre></div></div>
</p>
</li>
<li>
<p><strong>Control de errores</strong>: Siempre verificar resultados de operaciones y manejar posibles errores.</p>
</li>
<li><strong>Paginación</strong>: Usar <code>skip()</code> y <code>limit()</code> para grandes conjuntos de datos.</li>
<li><strong>Consistencia</strong>: Considerar transacciones para operaciones relacionadas.</li>
<li><strong>Proyección</strong>: Solicitar solo los campos necesarios para reducir el uso de memoria y red.</li>
</ol></div>
</body>
</html>