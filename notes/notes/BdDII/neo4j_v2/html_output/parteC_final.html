<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   parteC
  </title>
 </head>
 <body>
  <h1 id="parte-c-cypher-intermedio">
   Parte C: Cypher Intermedio
  </h1>
  <div class="toc" id="table-of-contents">
   <h2 id="contents-header">
    Tabla de contenidos
   </h2>
   <ul class="toc">
    <li class="toc">
     <a class="toc" href="#31-agregaciones-count-sum-avg">
      3.1 Agregaciones: COUNT, SUM, AVG
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#32-agrupamiento-con-with">
      3.2 Agrupamiento con WITH
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#33-funciones-de-coleccion">
      3.3 Funciones de colección
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#34-order-by-y-limit">
      3.4 ORDER BY y LIMIT
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#35-funciones-de-texto-y-fechas">
      3.5 Funciones de texto y fechas
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#36-optional-match-y-manejo-de-nulos">
      3.6 OPTIONAL MATCH y manejo de nulos
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#37-modificacion-de-datos-update-y-delete">
      3.7 Modificación de datos: UPDATE y DELETE
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#38-merge-evitar-duplicados">
      3.8 MERGE - Evitar duplicados
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#39-relaciones-dinamicas-y-patrones-avanzados">
      3.9 Relaciones dinámicas y patrones avanzados
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#310-laboratorio-practico-sistema-de-e-commerce">
      3.10 Laboratorio práctico: Sistema de e-commerce
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#311-ejercicios-de-practica">
      3.11 Ejercicios de práctica
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#312-funciones-avanzadas">
      3.12 Funciones avanzadas
     </a>
    </li>
    <li class="toc">
     <a class="toc" href="#resume">
      Resume
     </a>
    </li>
   </ul>
  </div>
  <div class="chapter-container">
   <h2 id="31-agregaciones-count-sum-avg">
    3.1 Agregaciones: COUNT, SUM, AVG
   </h2>
   <h3 id="count-contar-elementos">
    COUNT - Contar elementos
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Contar todos los nodos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

<span class="c1">// Contar nodos por etiqueta</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_personas</span><span class="p">;</span>

<span class="c1">// Contar relaciones</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">()</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">CONOCE</span><span class="o">]-&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_conocimientos</span><span class="p">;</span>

<span class="c1">// COUNT con DISTINCT</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">departamentos_con_empleados</span><span class="p">;</span>

<span class="c1">// COUNT con propiedades</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">personas_con_email</span><span class="p">;</span><span class="w">  </span><span class="c1">// No cuenta NULL</span>
</pre>
    </div>
   </div>
   <h3 id="sum-sumar-valores">
    SUM - Sumar valores
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Sumar salarios por departamento</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">masa_salarial</span><span class="p">;</span>

<span class="c1">// Sumar horas de trabajo por proyecto</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Proyecto</span><span class="p">)</span><span class="o">&lt;-[</span><span class="n">a</span><span class="p">:</span><span class="n">ASIGNADO_A</span><span class="o">]-</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">horas_semana</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_horas</span><span class="p">;</span>

<span class="c1">// Sumar con condiciones</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">años_empresa</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">2</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salarios_empleados_senior</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="avg-promedio">
    AVG - Promedio
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Salario promedio</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salario_promedio</span>

<span class="c1">// Promedio por departamento</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salario_promedio_depto</span>

<span class="c1">// Valoración promedio de películas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span><span class="o">-[</span><span class="n">v</span><span class="p">:</span><span class="n">VALORO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Pelicula</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">puntuacion</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">valoracion_promedio</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">valoracion_promedio</span><span class="w"> </span><span class="k">DESC</span>
</pre>
    </div>
   </div>
   <h3 id="min-y-max">
    MIN y MAX
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Salario mínimo y máximo</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="w"> </span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salario_minimo</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salario_maximo</span><span class="p">;</span>

<span class="c1">// Empleado más joven y más veterano</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">años_empresa</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">menos_antiguedad</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">años_empresa</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mas_antiguedad</span><span class="p">;</span>

<span class="c1">// Película más larga por género</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Pelicula</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">g</span><span class="p">:</span><span class="n">Genero</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">duracion</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pelicula_mas_larga</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="32-agrupamiento-con-with">
    3.2 Agrupamiento con WITH
   </h2>
   <h3 id="concepto-de-with">
    Concepto de WITH
   </h3>
   <p>
    <code>
     WITH
    </code>
    es como un "punto y coma" en Cypher. Te permite:
   </p>
   <ul>
    <li>
     Pasar resultados a la siguiente parte de la consulta
    </li>
    <li>
     Hacer agregaciones intermedias
    </li>
    <li>
     Filtrar resultados agregados
    </li>
    <li>
     Renombrar variables
    </li>
   </ul>
   <div class="highlight language-cypher">
    <pre><span></span><span class="c1">// Sintaxis básica</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">patron</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">variable1</span><span class="p">,</span><span class="w"> </span><span class="n">variable2</span><span class="p">,</span><span class="w"> </span><span class="n">agregacion</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">otro_patron</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">resultado</span><span class="p">;</span>
</pre>
   </div>
   <h3 id="ejemplos-practicos-de-with">
    Ejemplos prácticos de WITH
   </h3>
   <p>
    <strong>
     Encontrar empleados con salario mayor al promedio:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Paso 1: Calcular promedio</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">salario_promedio</span><span class="p">;</span>

<span class="c1">// Paso 2: Encontrar empleados sobre el promedio</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">emp</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">emp</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">salario_promedio</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">emp</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">emp</span><span class="p">.</span><span class="n">salario</span><span class="p">,</span><span class="w"> </span><span class="n">salario_promedio</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <p>
    <strong>
     Top 3 departamentos por masa salarial:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">masa_salarial</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">masa_salarial</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">3</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">masa_salarial</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     Empleados que trabajan en proyectos múltiples:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ASIGNADO_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Proyecto</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_proyectos</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">num_proyectos</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">1</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ASIGNADO_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">proyecto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">num_proyectos</span><span class="p">,</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">proyecto</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">proyectos</span><span class="p">;</span>
</pre>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="33-funciones-de-coleccion">
    3.3 Funciones de colección
   </h2>
   <h3 id="collect-recopilar-en-listas">
    COLLECT - Recopilar en listas
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Recopilar nombres</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">todos_los_nombres</span><span class="p">;</span>

<span class="c1">// Agrupar empleados por departamento</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">empleados</span><span class="p">;</span>

<span class="c1">// Recopilar con propiedades múltiples</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="k">collect</span><span class="p">({</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">salario</span><span class="p">:</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">})</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">empleados_info</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="size-tamano-de-colecciones">
    SIZE - Tamaño de colecciones
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Contar elementos en una lista</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">:</span><span class="n">Departamento</span><span class="p">)</span><span class="o">&lt;-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">empleados</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">empleados</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cantidad_empleados</span><span class="p">;</span>

<span class="c1">// Usar con propiedades de tipo lista</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">tags</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">2</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">tags</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="funciones-de-manipulacion-de-listas">
    Funciones de manipulación de listas
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// HEAD - primer elemento</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombres</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="n">nombres</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">primer_nombre</span><span class="p">;</span>

<span class="c1">// TAIL - todos excepto el primero</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombres</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">tail</span><span class="p">(</span><span class="n">nombres</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">resto_nombres</span><span class="p">;</span>

<span class="c1">// REVERSE - invertir orden</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="k">collect</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombres</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">reverse</span><span class="p">(</span><span class="n">nombres</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombres_inverso</span><span class="p">;</span>

<span class="c1">// RANGE - generar secuencias</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">numeros</span><span class="p">;</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">multiplos_de_10</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="34-order-by-y-limit">
    3.4 ORDER BY y LIMIT
   </h2>
   <h3 id="order-by-ordenamiento">
    ORDER BY - Ordenamiento
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Orden ascendente (por defecto)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">;</span>

<span class="c1">// Orden descendente</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">// Múltiples criterios</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">años_empresa</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">años_empresa</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">// Ordenar por expresiones</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">edad</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">edad_meses</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">edad_meses</span><span class="w">  </span><span class="c1">// Ordenar por edad en meses</span>
</pre>
    </div>
   </div>
   <h3 id="limit-y-skip">
    LIMIT y SKIP
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Top 5 empleados mejor pagados</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">5</span><span class="p">;</span>

<span class="c1">// Paginación con SKIP</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">SKIP</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">5</span><span class="p">;</span><span class="w">  </span><span class="c1">// Empleados del 6 al 10</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="35-funciones-de-texto-y-fechas">
    3.5 Funciones de texto y fechas
   </h2>
   <h3 id="funciones-de-texto">
    Funciones de texto
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'  Juan  '</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'ejemplo@email.com'</span><span class="p">});</span>

<span class="c1">// UPPER y LOWER</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">upper</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombre_mayusculas</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">email_minusculas</span><span class="p">;</span>

<span class="c1">// TRIM - eliminar espacios</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'  Juan  '</span><span class="p">})</span>
<span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">trim</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">;</span>

<span class="c1">// SUBSTRING</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">substring</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">iniciales</span><span class="p">;</span>

<span class="c1">// SPLIT - dividir texto</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">'@'</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">'@'</span><span class="p">)</span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dominio</span><span class="p">;</span>

<span class="c1">// REPLACE</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="s">'á'</span><span class="p">,</span><span class="w"> </span><span class="s">'a'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nombre_sin_acentos</span><span class="p">;</span>

<span class="c1">// SIZE - longitud de texto</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">10</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">longitud</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="funciones-de-fechas">
    Funciones de fechas
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Fecha actual</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">date</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hoy</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ahora</span><span class="p">;</span>

<span class="c1">// Crear fechas específicas</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-12-25'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">navidad</span><span class="p">;</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="s">'2023-12-25T10:30:00'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">navidad_con_hora</span><span class="p">;</span>

<span class="c1">// Componentes de fecha</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">CONTRATADO</span><span class="w"> </span><span class="p">{</span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-06-15'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">()</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">r</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">year</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">año</span><span class="p">,</span>
<span class="w">       </span><span class="n">r</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">month</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mes</span><span class="p">,</span>
<span class="w">       </span><span class="n">r</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">day</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dia</span><span class="p">;</span>

<span class="c1">// Operaciones con fechas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">fecha_contratacion</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">e</span><span class="p">.</span><span class="n">fecha_contratacion</span><span class="p">,</span>
<span class="w">       </span><span class="n">duration</span><span class="p">.</span><span class="n">between</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">fecha_contratacion</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="p">())</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tiempo_empresa</span><span class="p">;</span>

<span class="c1">// Formato de fechas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">evento</span><span class="p">:</span><span class="n">Evento</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">evento</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">toString</span><span class="p">(</span><span class="n">evento</span><span class="p">.</span><span class="n">fecha</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">fecha_texto</span><span class="p">,</span>
<span class="w">       </span><span class="n">evento</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">year</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="s">'-'</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="n">evento</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">month</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">año_mes</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="36-optional-match-y-manejo-de-nulos">
    3.6 OPTIONAL MATCH y manejo de nulos
   </h2>
   <h3 id="optional-match-coincidencias-opcionales">
    OPTIONAL MATCH - Coincidencias opcionales
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Similar a LEFT JOIN en SQL</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ASIGNADO_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Proyecto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">proyecto</span><span class="p">;</span>

<span class="c1">// Múltiples OPTIONAL MATCH</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">empresa</span><span class="p">:</span><span class="n">Empresa</span><span class="p">)</span>
<span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VIVE_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">ciudad</span><span class="p">:</span><span class="n">Ciudad</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">empresa</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">ciudad</span><span class="p">.</span><span class="n">nombre</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="manejo-de-valores-null">
    Manejo de valores NULL
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// COALESCE - primer valor no null</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">empresa</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">coalesce</span><span class="p">(</span><span class="n">empresa</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="s">'Desempleado'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">estado_laboral</span><span class="p">;</span>

<span class="c1">// CASE - condicionales</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span>
<span class="w">       </span><span class="k">CASE</span><span class="w"> </span>
<span class="w">         </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">70000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s">'Alto'</span>
<span class="w">         </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s">'Medio'</span>
<span class="w">         </span><span class="n">ELSE</span><span class="w"> </span><span class="s">'Bajo'</span>
<span class="w">       </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rango_salarial</span><span class="p">;</span>

<span class="c1">// IS NULL y IS NOT NULL</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">email</span><span class="p">;</span>

<span class="c1">// Contar valores no nulos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">telefono</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">personas_con_telefono</span><span class="p">,</span>
<span class="w">       </span><span class="n">count</span><span class="p">(*)</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">telefono</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">personas_sin_telefono</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="37-modificacion-de-datos-update-y-delete">
    3.7 Modificación de datos: UPDATE y DELETE
   </h2>
   <h3 id="set-actualizar-propiedades">
    SET - Actualizar propiedades
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Actualizar una propiedad</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Juan'</span><span class="p">})</span>
<span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">edad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m">31</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="c1">// Actualizar múltiples propiedades</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana García'</span><span class="p">})</span>
<span class="k">SET</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m">70000</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">puesto</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Lead Developer'</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>

<span class="c1">// Agregar nueva propiedad</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">fecha_actualizacion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">()</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">personas_actualizadas</span><span class="p">;</span>

<span class="c1">// Actualizar desde otra propiedad</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span>
<span class="k">SET</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario_anual</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salario</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">12</span><span class="p">;</span>

<span class="c1">// Copiar propiedades</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Juan'</span><span class="p">}),</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'María'</span><span class="p">})</span>
<span class="k">SET</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="err">+</span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">telefono</span><span class="p">:</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">telefono</span><span class="p">};</span>
</pre>
    </div>
   </div>
   <h3 id="remove-eliminar-propiedades-y-etiquetas">
    REMOVE - Eliminar propiedades y etiquetas
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Eliminar propiedad</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Juan'</span><span class="p">})</span>
<span class="k">REMOVE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">edad</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="c1">// Eliminar etiqueta</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">:</span><span class="n">Temporal</span><span class="p">)</span>
<span class="k">REMOVE</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="n">Temporal</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="c1">// Eliminar múltiples propiedades</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">REMOVE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">campo_temporal</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">otro_campo_temporal</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="delete-eliminar-nodos-y-relaciones">
    DELETE - Eliminar nodos y relaciones
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Eliminar relación específica</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">CONOCE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">b</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Juan'</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'María'</span><span class="p">;</span>
<span class="k">DELETE</span><span class="w"> </span><span class="n">r</span>

<span class="c1">// Eliminar nodo (primero eliminar relaciones)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Juan'</span><span class="p">})</span>
<span class="n">DETACH</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w">  </span><span class="c1">// DETACH elimina automáticamente las relaciones</span>

<span class="c1">// Eliminar múltiples nodos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">activo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">false</span>
<span class="n">DETACH</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="c1">// Eliminar todo (¡CUIDADO!)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">DETACH</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="38-merge-evitar-duplicados">
    3.8 MERGE - Evitar duplicados
   </h2>
   <h3 id="concepto-de-merge">
    Concepto de MERGE
   </h3>
   <p>
    MERGE es una operación "upsert" que:
   </p>
   <ul>
    <li>
     Si encuentra el patrón, no hace nada (o usa ON MATCH)
    </li>
    <li>
     Si no lo encuentra, lo crea (o usa ON CREATE)
    </li>
   </ul>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// MERGE básico</span>
<span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'juan@email.com'</span><span class="p">})</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>

<span class="c1">// Con ON CREATE y ON MATCH</span>
<span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'juan@email.com'</span><span class="p">})</span>
<span class="k">ON</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Juan'</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">fecha_creacion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">()</span>
<span class="k">ON</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">fecha_ultima_actualizacion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">()</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</pre>
    </div>
   </div>
   <h3 id="ejemplos-practicos-de-merge">
    Ejemplos prácticos de MERGE
   </h3>
   <p>
    <strong>
     Sistema de tags:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="c1">// Crear o encontrar tags</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">articulo</span><span class="p">:</span><span class="n">Articulo</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">123</span><span class="p">})</span>
<span class="k">FOREACH</span><span class="w"> </span><span class="p">(</span><span class="n">tag_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="o">[</span><span class="s">'neo4j'</span><span class="p">,</span><span class="w"> </span><span class="s">'grafos'</span><span class="p">,</span><span class="w"> </span><span class="s">'bases-datos'</span><span class="o">]</span><span class="w"> </span><span class="p">|</span>
<span class="w">  </span><span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">tag</span><span class="p">:</span><span class="n">Tag</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="n">tag_name</span><span class="p">})</span>
<span class="w">  </span><span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">articulo</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TIENE_TAG</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
<span class="p">)</span>
</pre>
   </div>
   <p>
    <strong>
     Importación de datos sin duplicados:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Asegurar que cada persona existe solo una vez</span>
<span class="k">UNWIND</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'ana@email.com'</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Bob'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'bob@email.com'</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'ana@email.com'</span><span class="p">}</span><span class="w">  </span><span class="c1">// Duplicado</span>
<span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">persona_data</span>

<span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="n">persona_data</span><span class="p">.</span><span class="n">email</span><span class="p">})</span>
<span class="k">ON</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">persona_data</span><span class="p">.</span><span class="n">nombre</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</pre>
    </div>
   </div>
   <p>
    <strong>
     Relaciones únicas:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Evitar relaciones duplicadas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">}),</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Bob'</span><span class="p">})</span>
<span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="c1">// MERGE con propiedades en relaciones</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">:</span><span class="n">Usuario</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">123</span><span class="p">}),</span><span class="w"> </span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">456</span><span class="p">})</span>
<span class="k">MERGE</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">COMPRO</span><span class="w"> </span><span class="p">{</span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-10-01'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">cantidad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">precio</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">producto</span><span class="p">.</span><span class="n">precio</span>
<span class="k">ON</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">cantidad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">cantidad</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="m">1</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="39-relaciones-dinamicas-y-patrones-avanzados">
    3.9 Relaciones dinámicas y patrones avanzados
   </h2>
   <h3 id="relaciones-con-longitud-variable">
    Relaciones con longitud variable
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Buscar en 1 a 3 saltos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">inicio</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">})</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="m">1</span><span class="p">..</span><span class="m">3</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">destino</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">destino</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">grados_separacion</span>

<span class="c1">// Cualquier longitud (¡CUIDADO con grafos grandes!)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">inicio</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">destino</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">inicio</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Ana'</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">destino</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Carlos'</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">path</span>

<span class="c1">// Longitud exacta</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">inicio</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="m">2</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">destino</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">inicio</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Ana'</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">destino</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">amigos_de_amigos</span>

<span class="c1">// Con filtros en nodos intermedios</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">inicio</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="m">2</span><span class="p">..</span><span class="m">4</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">destino</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">ALL</span><span class="p">(</span><span class="n">persona</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">nodes</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">persona</span><span class="p">.</span><span class="n">edad</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">18</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">destino</span><span class="p">.</span><span class="n">nombre</span>
</pre>
    </div>
   </div>
   <h3 id="multiples-tipos-de-relaciones">
    Múltiples tipos de relaciones
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// OR en tipos de relaciones</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Persona</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="p">|:</span><span class="n">ESTUDIA_EN</span><span class="p">|:</span><span class="n">VIVE_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">lugar</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tipo_relacion</span><span class="p">,</span><span class="w"> </span><span class="n">lugar</span><span class="p">.</span><span class="n">nombre</span>

<span class="c1">// Patrones complejos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">empleado</span><span class="p">:</span><span class="n">Empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">TRABAJA_EN</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">dept</span><span class="p">:</span><span class="n">Departamento</span><span class="p">),</span>
<span class="w">      </span><span class="p">(</span><span class="n">empleado</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ASIGNADO_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">proyecto</span><span class="p">:</span><span class="n">Proyecto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">dept</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Desarrollo'</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">empleado</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">proyecto</span><span class="p">.</span><span class="n">nombre</span>
</pre>
    </div>
   </div>
   <h3 id="funciones-de-path-camino">
    Funciones de path (camino)
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Información sobre paths</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">inicio</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">inicio</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Ana'</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">fin</span><span class="p">.</span><span class="n">nombre</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">'Carlos'</span>
<span class="k">RETURN</span><span class="w"> </span>
<span class="w">  </span><span class="n">length</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">longitud</span><span class="p">,</span>
<span class="w">  </span><span class="n">nodes</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nodos_en_camino</span><span class="p">,</span>
<span class="w">  </span><span class="n">relationships</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">relaciones_en_camino</span>

<span class="c1">// Camino más corto</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">shortestPath</span><span class="p">((</span><span class="n">inicio</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">})</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="o">]-</span><span class="p">(</span><span class="n">fin</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Carlos'</span><span class="p">}))</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1">// Todos los caminos más cortos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">allShortestPaths</span><span class="p">((</span><span class="n">inicio</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana'</span><span class="p">})</span><span class="o">-[</span><span class="p">:</span><span class="n">CONOCE</span><span class="p">*</span><span class="o">]-</span><span class="p">(</span><span class="n">fin</span><span class="p">:</span><span class="n">Persona</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Carlos'</span><span class="p">}))</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">path</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="310-laboratorio-practico-sistema-de-e-commerce">
    3.10 Laboratorio práctico: Sistema de e-commerce
   </h2>
   <h3 id="objetivo">
    Objetivo
   </h3>
   <p>
    Crear un sistema de e-commerce completo con usuarios, productos, categorías, pedidos y valoraciones.
   </p>
   <h3 id="paso-1-crear-el-modelo-de-datos">
    Paso 1: Crear el modelo de datos
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Limpiar base de datos</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">DETACH</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="c1">// Crear usuarios</span>
<span class="k">CREATE</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">:</span><span class="n">Usuario</span><span class="p">:</span><span class="n">Cliente</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana García'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'ana@email.com'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">fecha_registro</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-01-15'</span><span class="p">),</span><span class="w"> </span><span class="n">ciudad</span><span class="p">:</span><span class="w"> </span><span class="s">'Madrid'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">bob</span><span class="p">:</span><span class="n">Usuario</span><span class="p">:</span><span class="n">Cliente</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Bob Johnson'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'bob@email.com'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">fecha_registro</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-02-20'</span><span class="p">),</span><span class="w"> </span><span class="n">ciudad</span><span class="p">:</span><span class="w"> </span><span class="s">'Barcelona'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">carla</span><span class="p">:</span><span class="n">Usuario</span><span class="p">:</span><span class="n">Cliente</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Carla López'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'carla@email.com'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">fecha_registro</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-03-10'</span><span class="p">),</span><span class="w"> </span><span class="n">ciudad</span><span class="p">:</span><span class="w"> </span><span class="s">'Madrid'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">david</span><span class="p">:</span><span class="n">Usuario</span><span class="p">:</span><span class="n">Cliente</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'David Chen'</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="s">'david@email.com'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">fecha_registro</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-04-05'</span><span class="p">),</span><span class="w"> </span><span class="n">ciudad</span><span class="p">:</span><span class="w"> </span><span class="s">'Valencia'</span>
<span class="w">  </span><span class="p">}),</span>

<span class="c1">// Crear categorías</span>
<span class="w">  </span><span class="p">(</span><span class="n">electronica</span><span class="p">:</span><span class="n">Categoria</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Electrónica'</span><span class="p">,</span><span class="w"> </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Dispositivos electrónicos'</span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">ropa</span><span class="p">:</span><span class="n">Categoria</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ropa'</span><span class="p">,</span><span class="w"> </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Vestimenta y accesorios'</span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">hogar</span><span class="p">:</span><span class="n">Categoria</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Hogar'</span><span class="p">,</span><span class="w"> </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Artículos para el hogar'</span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">libros</span><span class="p">:</span><span class="n">Categoria</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Libros'</span><span class="p">,</span><span class="w"> </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Literatura y educación'</span><span class="p">}),</span>

<span class="c1">// Crear productos</span>
<span class="w">  </span><span class="p">(</span><span class="n">laptop</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">101</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Laptop Dell XPS'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">1299</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Laptop de alta gama'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'Dell'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">iphone</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">102</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'iPhone 14'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">999</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Smartphone Apple'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'Apple'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">camisa</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">201</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Camisa Casual'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">49</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Camisa de algodón'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'Zara'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">jeans</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">202</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Jeans Clásicos'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">79</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">18</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Pantalón denim azul'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'Levi\'s'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">mesa</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">301</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Mesa de Comedor'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">299</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Mesa de madera roble'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'IKEA'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">libro_neo4j</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">401</span><span class="p">,</span><span class="w"> </span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Learning Neo4j'</span><span class="p">,</span><span class="w"> </span><span class="n">precio</span><span class="p">:</span><span class="w"> </span><span class="m">39</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="p">:</span><span class="w"> </span><span class="m">12</span><span class="p">,</span>
<span class="w">    </span><span class="n">descripcion</span><span class="p">:</span><span class="w"> </span><span class="s">'Guía completa de Neo4j'</span><span class="p">,</span><span class="w"> </span><span class="n">marca</span><span class="p">:</span><span class="w"> </span><span class="s">'O\'Reilly'</span>
<span class="w">  </span><span class="p">}),</span>

<span class="c1">// Productos pertenecen a categorías</span>
<span class="w">  </span><span class="p">(</span><span class="n">laptop</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">electronica</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">iphone</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">electronica</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">camisa</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">ropa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">jeans</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">ropa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">mesa</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">hogar</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">libro_neo4j</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">libros</span><span class="p">),</span>

<span class="c1">// Crear pedidos</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido1</span><span class="p">:</span><span class="n">Pedido</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">1001</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-01'</span><span class="p">),</span><span class="w"> </span><span class="n">estado</span><span class="p">:</span><span class="w"> </span><span class="s">'Entregado'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">total</span><span class="p">:</span><span class="w"> </span><span class="m">1349</span><span class="p">.</span><span class="m">98</span><span class="p">,</span><span class="w"> </span><span class="n">direccion_envio</span><span class="p">:</span><span class="w"> </span><span class="s">'Madrid, España'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido2</span><span class="p">:</span><span class="n">Pedido</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">1002</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-15'</span><span class="p">),</span><span class="w"> </span><span class="n">estado</span><span class="p">:</span><span class="w"> </span><span class="s">'En tránsito'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">total</span><span class="p">:</span><span class="w"> </span><span class="m">129</span><span class="p">.</span><span class="m">98</span><span class="p">,</span><span class="w"> </span><span class="n">direccion_envio</span><span class="p">:</span><span class="w"> </span><span class="s">'Barcelona, España'</span>
<span class="w">  </span><span class="p">}),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido3</span><span class="p">:</span><span class="n">Pedido</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="m">1003</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-20'</span><span class="p">),</span><span class="w"> </span><span class="n">estado</span><span class="p">:</span><span class="w"> </span><span class="s">'Procesando'</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">total</span><span class="p">:</span><span class="w"> </span><span class="m">299</span><span class="p">.</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="n">direccion_envio</span><span class="p">:</span><span class="w"> </span><span class="s">'Madrid, España'</span>
<span class="w">  </span><span class="p">}),</span>

<span class="c1">// Usuarios realizan pedidos</span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido1</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">bob</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido2</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">carla</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido3</span><span class="p">),</span>

<span class="c1">// Pedidos contienen productos</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido1</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="w"> </span><span class="p">{</span><span class="n">cantidad</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">precio_unitario</span><span class="p">:</span><span class="w"> </span><span class="m">1299</span><span class="p">.</span><span class="m">99</span><span class="p">}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">laptop</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido1</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="w"> </span><span class="p">{</span><span class="n">cantidad</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">precio_unitario</span><span class="p">:</span><span class="w"> </span><span class="m">49</span><span class="p">.</span><span class="m">99</span><span class="p">}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">camisa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido2</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="w"> </span><span class="p">{</span><span class="n">cantidad</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">precio_unitario</span><span class="p">:</span><span class="w"> </span><span class="m">79</span><span class="p">.</span><span class="m">99</span><span class="p">}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">jeans</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido2</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="w"> </span><span class="p">{</span><span class="n">cantidad</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">precio_unitario</span><span class="p">:</span><span class="w"> </span><span class="m">49</span><span class="p">.</span><span class="m">99</span><span class="p">}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">camisa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pedido3</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="w"> </span><span class="p">{</span><span class="n">cantidad</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">precio_unitario</span><span class="p">:</span><span class="w"> </span><span class="m">299</span><span class="p">.</span><span class="m">99</span><span class="p">}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">mesa</span><span class="p">),</span>

<span class="c1">// Usuarios valoran productos</span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="w"> </span><span class="p">{</span><span class="n">puntuacion</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">comentario</span><span class="p">:</span><span class="w"> </span><span class="s">'Excelente laptop'</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-05'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">laptop</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="w"> </span><span class="p">{</span><span class="n">puntuacion</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">comentario</span><span class="p">:</span><span class="w"> </span><span class="s">'Buena calidad'</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-06'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">camisa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">bob</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="w"> </span><span class="p">{</span><span class="n">puntuacion</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">comentario</span><span class="p">:</span><span class="w"> </span><span class="s">'Cómodos y duraderos'</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-18'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">jeans</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">carla</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="w"> </span><span class="p">{</span><span class="n">puntuacion</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">comentario</span><span class="p">:</span><span class="w"> </span><span class="s">'Esperaba mejor calidad'</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-22'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">mesa</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">david</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="w"> </span><span class="p">{</span><span class="n">puntuacion</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">comentario</span><span class="p">:</span><span class="w"> </span><span class="s">'Muy útil para aprender'</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span><span class="p">:</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-09-25'</span><span class="p">)}</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">libro_neo4j</span><span class="p">),</span>

<span class="c1">// Usuarios siguen a otros (para recomendaciones sociales)</span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">bob</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">bob</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">ana</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">ana</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">carla</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">carla</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">david</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">david</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">ana</span><span class="p">);</span>
</pre>
    </div>
   </div>
   <h3 id="paso-2-consultas-de-analisis-de-negocio">
    Paso 2: Consultas de análisis de negocio
   </h3>
   <p>
    <strong>
     1. Productos más vendidos:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span><span class="o">&lt;-[</span><span class="n">c</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-</span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">producto</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">cantidad</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_vendido</span><span class="p">,</span>
<span class="w">       </span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">cantidad</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">precio_unitario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ingresos_totales</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">total_vendido</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     2. Clientes más valiosos:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">cliente</span><span class="p">:</span><span class="n">Cliente</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">cliente</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">pedido</span><span class="p">.</span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">valor_total_cliente</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">pedido</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_pedidos</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">cliente</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">valor_total_cliente</span><span class="p">,</span><span class="w"> </span><span class="n">num_pedidos</span><span class="p">,</span>
<span class="w">       </span><span class="n">valor_total_cliente</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="n">num_pedidos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">valor_promedio_pedido</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">valor_total_cliente</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     3. Análisis de valoraciones por categoría:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span><span class="o">-[</span><span class="n">v</span><span class="p">:</span><span class="n">VALORO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">categoria</span><span class="p">:</span><span class="n">Categoria</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">categoria</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">puntuacion</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">valoracion_promedio</span><span class="p">,</span>
<span class="w">       </span><span class="n">count</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_valoraciones</span><span class="p">,</span>
<span class="w">       </span><span class="k">collect</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">producto</span><span class="p">.</span><span class="n">nombre</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="p">..</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">productos_muestra</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">valoracion_promedio</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     4. Tendencias temporales de ventas:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">pedido</span><span class="p">.</span><span class="n">fecha</span><span class="p">.</span><span class="n">month</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mes</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">pedido</span><span class="p">.</span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ventas_mes</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">mes</span><span class="p">,</span><span class="w"> </span><span class="n">ventas_mes</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mes</span><span class="p">;</span>
</pre>
   </div>
   <h3 id="paso-3-sistema-de-recomendaciones">
    Paso 3: Sistema de recomendaciones
   </h3>
   <p>
    <strong>
     1. Recomendaciones basadas en productos similares:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Usuarios que compraron X también compraron Y</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">producto_base</span><span class="p">:</span><span class="n">Producto</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Laptop Dell XPS'</span><span class="p">})</span><span class="o">&lt;-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-</span><span class="p">(</span><span class="n">pedido1</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span><span class="o">&lt;-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-</span><span class="p">(</span><span class="n">usuario</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido2</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto_recomendado</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">producto_recomendado</span><span class="w"> </span><span class="p">&lt;&gt;</span><span class="w"> </span><span class="n">producto_base</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">producto_recomendado</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(*)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">veces_comprado_junto</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">veces_comprado_junto</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">5</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <p>
    <strong>
     2. Recomendaciones sociales:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Productos que compraron personas que sigo</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">yo</span><span class="p">:</span><span class="n">Usuario</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana García'</span><span class="p">})</span><span class="o">-[</span><span class="p">:</span><span class="n">SIGUE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">amigo</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">amigo</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">EXISTS</span><span class="p">((</span><span class="n">yo</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">))</span>
<span class="k">OPTIONAL</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">amigo</span><span class="p">)</span><span class="o">-[</span><span class="n">v</span><span class="p">:</span><span class="n">VALORO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">producto</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">amigo</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">amigos_que_compraron</span><span class="p">,</span>
<span class="w">       </span><span class="n">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">puntuacion</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">valoracion_promedio</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">amigos_que_compraron</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">valoracion_promedio</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">5</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <p>
    <strong>
     3. Productos trending en mi ciudad:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">yo</span><span class="p">:</span><span class="n">Usuario</span><span class="w"> </span><span class="p">{</span><span class="n">nombre</span><span class="p">:</span><span class="w"> </span><span class="s">'Ana García'</span><span class="p">})</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">otros</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">otros</span><span class="p">.</span><span class="n">ciudad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">yo</span><span class="p">.</span><span class="n">ciudad</span><span class="w"> </span>
<span class="w">  </span><span class="n">AND</span><span class="w"> </span><span class="n">pedido</span><span class="p">.</span><span class="n">fecha</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-08-01'</span><span class="p">)</span><span class="w">  </span><span class="c1">// Últimas compras</span>
<span class="w">  </span><span class="n">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">EXISTS</span><span class="p">((</span><span class="n">yo</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">producto</span><span class="p">))</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">producto</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">count</span><span class="p">(*)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">popularidad_local</span><span class="p">,</span>
<span class="w">       </span><span class="n">producto</span><span class="p">.</span><span class="n">precio</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">popularidad_local</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">5</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="paso-4-analisis-de-inventario-y-alertas">
    Paso 4: Análisis de inventario y alertas
   </h3>
   <p>
    <strong>
     1. Productos con stock bajo:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="m">10</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">precio</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     2. Productos sin ventas recientes:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">EXISTS</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&lt;-[</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-</span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pedido</span><span class="p">.</span><span class="n">fecha</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">date</span><span class="p">(</span><span class="s">'2023-08-01'</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">stock</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">;</span>
</pre>
   </div>
   <p>
    <strong>
     3. Análisis de rentabilidad por categoría:
    </strong>
   </p>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">categoria</span><span class="p">:</span><span class="n">Categoria</span><span class="p">)</span><span class="o">&lt;-[</span><span class="p">:</span><span class="n">PERTENECE_A</span><span class="o">]-</span><span class="p">(</span><span class="n">producto</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span><span class="o">&lt;-[</span><span class="n">c</span><span class="p">:</span><span class="n">CONTIENE</span><span class="o">]-</span><span class="p">(</span><span class="n">pedido</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="k">WITH</span><span class="w"> </span><span class="n">categoria</span><span class="p">,</span><span class="w"> </span>
<span class="w">     </span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">cantidad</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">precio_unitario</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ingresos</span><span class="p">,</span>
<span class="w">     </span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">cantidad</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">unidades_vendidas</span><span class="p">,</span>
<span class="w">     </span><span class="n">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">producto</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">productos_diferentes</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">categoria</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">ingresos</span><span class="p">,</span><span class="w"> </span><span class="n">unidades_vendidas</span><span class="p">,</span><span class="w"> </span><span class="n">productos_diferentes</span><span class="p">,</span>
<span class="w">       </span><span class="n">ingresos</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="n">productos_diferentes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ingreso_promedio_por_producto</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ingresos</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="311-ejercicios-de-practica">
    3.11 Ejercicios de práctica
   </h2>
   <h3 id="ejercicio-1-analisis-de-usuarios">
    Ejercicio 1: Análisis de usuarios
   </h3>
   <p>
    Usando el dataset del e-commerce, responde:
   </p>
   <ol>
    <li>
     ¿Cuál es el gasto promedio por pedido de cada usuario?
    </li>
    <li>
     ¿Qué usuarios han valorado productos pero nunca han comprado nada?
    </li>
    <li>
     ¿Cuál es la distribución de usuarios por ciudad?
    </li>
   </ol>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Soluciones propuestas:</span>

<span class="c1">// 1. Gasto promedio por pedido</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Pedido</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">total</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">gasto_promedio</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">gasto_promedio</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">// 2. Usuarios que valoran pero no compran</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">VALORO</span><span class="o">]-&gt;</span><span class="p">(:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">EXISTS</span><span class="p">((</span><span class="n">u</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">REALIZO_PEDIDO</span><span class="o">]-&gt;</span><span class="p">())</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">nombre</span><span class="p">;</span>

<span class="c1">// 3. Distribución por ciudad</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">:</span><span class="n">Usuario</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">ciudad</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">usuarios_por_ciudad</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">usuarios_por_ciudad</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="ejercicio-2-optimizacion-de-inventario">
    Ejercicio 2: Optimización de inventario
   </h3>
   <ol>
    <li>
     Identifica productos que deberían reabastecerse (stock bajo + alta demanda)
    </li>
    <li>
     Encuentra productos que podrían descontinuarse (sin ventas + stock alto)
    </li>
    <li>
     Calcula el valor total del inventario
    </li>
   </ol>
   <h3 id="ejercicio-3-analisis-de-red-social">
    Ejercicio 3: Análisis de red social
   </h3>
   <ol>
    <li>
     Encuentra quién tiene más seguidores
    </li>
    <li>
     Identifica usuarios que se siguen mutuamente
    </li>
    <li>
     Calcula el grado de separación promedio entre usuarios
    </li>
   </ol>
  </div>
  <div class="chapter-container">
   <h2 id="312-funciones-avanzadas">
    3.12 Funciones avanzadas
   </h2>
   <h3 id="funciones-matematicas">
    Funciones matemáticas
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Operaciones matemáticas básicas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span><span class="w"> </span>
<span class="w">       </span><span class="n">round</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_redondeado</span><span class="p">,</span>
<span class="w">       </span><span class="n">ceil</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_techo</span><span class="p">,</span>
<span class="w">       </span><span class="n">floor</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_piso</span><span class="p">,</span>
<span class="w">       </span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">diferencia_con_100</span><span class="p">;</span>

<span class="c1">// Funciones estadísticas</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_promedio</span><span class="p">,</span>
<span class="w">       </span><span class="n">stDev</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">desviacion_estandar</span><span class="p">,</span>
<span class="w">       </span><span class="n">percentileDisc</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">.</span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mediana</span><span class="p">,</span>
<span class="w">       </span><span class="n">percentileDisc</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">.</span><span class="m">25</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">primer_cuartil</span><span class="p">;</span>
</pre>
    </div>
   </div>
   <h3 id="funciones-de-conversion">
    Funciones de conversión
   </h3>
   <div class="highlight language-cypher">
    <div class="collapsible-container" data-max-lines="6">
     <pre><span></span><span class="c1">// Conversiones de tipo</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">Producto</span><span class="p">)</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">nombre</span><span class="p">,</span>
<span class="w">       </span><span class="n">toString</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_texto</span><span class="p">,</span>
<span class="w">       </span><span class="n">toInteger</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">precio</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">precio_entero</span><span class="p">,</span>
<span class="w">       </span><span class="n">toFloat</span><span class="p">(</span><span class="s">'123.45'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">numero_desde_texto</span><span class="p">;</span>

<span class="c1">// Trabajar con listas</span>
<span class="k">WITH</span><span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">numeros</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">reduce</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">numeros</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">suma</span><span class="p">,</span>
<span class="w">       </span><span class="o">[</span><span class="n">x</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">numeros</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mayores_que_tres</span><span class="p">,</span>
<span class="w">       </span><span class="o">[</span><span class="n">x</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">numeros</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">duplicados</span><span class="p">;</span>
</pre>
    </div>
   </div>
  </div>
  <div class="chapter-container">
   <h2 id="resume">
    Resume
   </h2>
   <p>
    En esta parte hemos aprendido:
   </p>
   <ul>
    <li>
     ✅ Agregaciones: COUNT, SUM, AVG, MIN, MAX
    </li>
    <li>
     ✅ Uso de WITH para consultas complejas
    </li>
    <li>
     ✅ Funciones de colección: COLLECT, SIZE
    </li>
    <li>
     ✅ Ordenamiento y paginación: ORDER BY, LIMIT, SKIP
    </li>
    <li>
     ✅ Funciones de texto y fechas
    </li>
    <li>
     ✅ OPTIONAL MATCH y manejo de NULL
    </li>
    <li>
     ✅ Modificación de datos: UPDATE, DELETE, MERGE
    </li>
    <li>
     ✅ Patrones avanzados y relaciones dinámicas
    </li>
    <li>
     ✅ Sistema completo de e-commerce con análisis avanzado
    </li>
   </ul>
  </div>
  <textarea id="css-editor" style="display:none;">pre {line-height: 125%;}

td.linenos .normal {color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;}

span.linenos {color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;}

td.linenos .special {color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px;}

span.linenos.special {color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px;}

.highlight .hll {background-color: #ffffcc;}

.highlight {background: #f8f8f8; padding: 0; border-radius: 5px; margin: 15px 0; background-color: #fef6e4 !important; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}

.highlight .c {color: #9a8052 !important; font-style: italic;}

/* Comment */
.highlight .err {border: 1px solid #F00;}

/* Error */
.highlight .k {color: #008000; font-weight: bold;}

/* Keyword */
.highlight .o {color: #666;}

/* Operator */
.highlight .ch {color: #3D7B7B; font-style: italic;}

/* Comment.Hashbang */
.highlight .cm {color: #3D7B7B; font-style: italic;}

/* Comment.Multiline */
.highlight .cp {color: #9C6500;}

/* Comment.Preproc */
.highlight .cpf {color: #3D7B7B; font-style: italic;}

/* Comment.PreprocFile */
.highlight .c1 {color: #3D7B7B; font-style: italic;}

/* Comment.Single */
.highlight .cs {color: #3D7B7B; font-style: italic;}

/* Comment.Special */
.highlight .gd {color: #A00000;}

/* Generic.Deleted */
.highlight .ge {font-style: italic;}

/* Generic.Emph */
.highlight .ges {font-weight: bold; font-style: italic;}

/* Generic.EmphStrong */
.highlight .gr {color: #E40000;}

/* Generic.Error */
.highlight .gh {color: #000080; font-weight: bold;}

/* Generic.Heading */
.highlight .gi {color: #008400;}

/* Generic.Inserted */
.highlight .go {color: #717171;}

/* Generic.Output */
.highlight .gp {color: #000080; font-weight: bold;}

/* Generic.Prompt */
.highlight .gs {font-weight: bold;}

/* Generic.Strong */
.highlight .gu {color: #800080; font-weight: bold;}

/* Generic.Subheading */
.highlight .gt {color: #04D;}

/* Generic.Traceback */
.highlight .kc {color: #008000; font-weight: bold;}

/* Keyword.Constant */
.highlight .kd {color: #008000; font-weight: bold;}

/* Keyword.Declaration */
.highlight .kn {color: #008000; font-weight: bold;}

/* Keyword.Namespace */
.highlight .kp {color: #008000;}

/* Keyword.Pseudo */
.highlight .kr {color: #008000; font-weight: bold;}

/* Keyword.Reserved */
.highlight .kt {color: #B00040;}

/* Keyword.Type */
.highlight .m {color: #666;}

/* Literal.Number */
.highlight .s {color: #BA2121;}

/* Literal.String */
.highlight .na {color: #687822;}

/* Name.Attribute */
.highlight .nb {color: #008000;}

/* Name.Builtin */
.highlight .nc {color: #00F; font-weight: bold;}

/* Name.Class */
.highlight .no {color: #800;}

/* Name.Constant */
.highlight .nd {color: #A2F;}

/* Name.Decorator */
.highlight .ni {color: #717171; font-weight: bold;}

/* Name.Entity */
.highlight .ne {color: #CB3F38; font-weight: bold;}

/* Name.Exception */
.highlight .nf {color: #00F;}

/* Name.Function */
.highlight .nl {color: #767600;}

/* Name.Label */
.highlight .nn {color: #00F; font-weight: bold;}

/* Name.Namespace */
.highlight .nt {color: #008000; font-weight: bold;}

/* Name.Tag */
.highlight .nv {color: #19177C;}

/* Name.Variable */
.highlight .ow {color: #A2F; font-weight: bold;}

/* Operator.Word */
.highlight .w {color: #BBB;}

/* Text.Whitespace */
.highlight .mb {color: #666;}

/* Literal.Number.Bin */
.highlight .mf {color: #666;}

/* Literal.Number.Float */
.highlight .mh {color: #666;}

/* Literal.Number.Hex */
.highlight .mi {color: #666;}

/* Literal.Number.Integer */
.highlight .mo {color: #666;}

/* Literal.Number.Oct */
.highlight .sa {color: #BA2121;}

/* Literal.String.Affix */
.highlight .sb {color: #BA2121;}

/* Literal.String.Backtick */
.highlight .sc {color: #BA2121;}

/* Literal.String.Char */
.highlight .dl {color: #BA2121;}

/* Literal.String.Delimiter */
.highlight .sd {color: #BA2121; font-style: italic;}

/* Literal.String.Doc */
.highlight .s2 {color: #BA2121;}

/* Literal.String.Double */
.highlight .se {color: #AA5D1F; font-weight: bold;}

/* Literal.String.Escape */
.highlight .sh {color: #BA2121;}

/* Literal.String.Heredoc */
.highlight .si {color: #A45A77; font-weight: bold;}

/* Literal.String.Interpol */
.highlight .sx {color: #008000;}

/* Literal.String.Other */
.highlight .sr {color: #A45A77;}

/* Literal.String.Regex */
.highlight .s1 {color: #BA2121;}

/* Literal.String.Single */
.highlight .ss {color: #19177C;}

/* Literal.String.Symbol */
.highlight .bp {color: #008000;}

/* Name.Builtin.Pseudo */
.highlight .fm {color: #00F;}

/* Name.Function.Magic */
.highlight .vc {color: #19177C;}

/* Name.Variable.Class */
.highlight .vg {color: #19177C;}

/* Name.Variable.Global */
.highlight .vi {color: #19177C;}

/* Name.Variable.Instance */
.highlight .vm {color: #19177C;}

/* Name.Variable.Magic */
.highlight .il {color: #666;}

body {font-family: Arial, sans-serif; line-height: 1.6; margin: 0 auto; padding: 20px;}

#main-title-block {background-color: #2e2e2e; color: #f0f0f0; padding: 18px; border-radius: 10px; border: 1px solid #444; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 1.8em; font-weight: bold; margin-bottom: 20px; text-align: center;}

pre:not(.highlight pre) {background-color: #fef6e4; color: #2e2e2e; padding: 12px; border-radius: 5px; overflow-x: auto; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin: 15px 0;}

code {font-family: "Courier New", Courier, monospace;}

.highlight pre {background: none; border: none; box-shadow: none; padding: 12px; margin: 0; border-radius: 0;}

.highlight .c1 {color: #9a8052 !important; font-style: italic;}

.highlight .cm {color: #9a8052 !important; font-style: italic;}

.highlight .k {color: #8250df !important; font-weight: normal;}

.highlight .kd {color: #8250df !important; font-weight: normal;}

.highlight .kn {color: #8250df !important; font-weight: normal;}

.highlight .s {color: #327d41 !important;}

.highlight .s1 {color: #327d41 !important;}

.highlight .s2 {color: #327d41 !important;}

.highlight .sb {color: #327d41 !important;}

.highlight .si {color: #327d41 !important;}

.highlight .m {color: #606060 !important;}

.highlight .mi {color: #606060 !important;}

.highlight .mf {color: #606060 !important;}

.highlight .o {color: #666666 !important; font-weight: normal;}

.highlight .ow {color: #666666 !important; font-weight: normal;}

.highlight .kc {color: #9a5b13 !important;}

.highlight .no {color: #9a5b13 !important;}

.highlight .nf {color: #606060 !important; font-weight: normal;}

.highlight .nb {color: #606060 !important; font-weight: normal;}

.highlight .nx {color: #606060 !important; font-weight: normal;}

.highlight .p {color: #666666 !important; font-weight: normal;}

.language-jsx .highlight .k {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-jsx .highlight .kd {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-jsx .highlight .kr {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-jsx .highlight .nx {color: #0969da !important; background: none !important; border: none !important;}

.language-jsx .highlight .nf {color: #0969da !important; background: none !important; border: none !important;}

.language-jsx .highlight .nt {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-jsx .highlight .nc {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-jsx .highlight .o {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-jsx .highlight .p {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-jsx .highlight .na {color: #0969da !important; background: none !important; border: none !important;}

.language-jsx .highlight .s {color: #0a3069 !important; background: none !important; border: none !important;}

.language-jsx .highlight .s1 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-jsx .highlight .s2 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-jsx .highlight .c {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-jsx .highlight .c1 {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-jsx .highlight .cm {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-jsx .highlight .m {color: #0969da !important; background: none !important; border: none !important;}

.language-jsx .highlight .mi {color: #0969da !important; background: none !important; border: none !important;}

.language-jsx .highlight .mf {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .k {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-react .highlight .kd {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-react .highlight .kr {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-react .highlight .nx {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .nf {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .nt {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-react .highlight .nc {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-react .highlight .o {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-react .highlight .p {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-react .highlight .na {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .s {color: #0a3069 !important; background: none !important; border: none !important;}

.language-react .highlight .s1 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-react .highlight .s2 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-react .highlight .c {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-react .highlight .c1 {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-react .highlight .cm {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-react .highlight .m {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .mi {color: #0969da !important; background: none !important; border: none !important;}

.language-react .highlight .mf {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .k {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-tsx .highlight .kd {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-tsx .highlight .kr {color: #af00db !important; font-weight: normal; background: none !important; border: none !important;}

.language-tsx .highlight .nx {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .nf {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .nt {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-tsx .highlight .nc {color: #116329 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-tsx .highlight .o {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-tsx .highlight .p {color: #666666 !important; background: none !important; border: none !important; box-shadow: none !important; outline: none !important;}

.language-tsx .highlight .na {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .s {color: #0a3069 !important; background: none !important; border: none !important;}

.language-tsx .highlight .s1 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-tsx .highlight .s2 {color: #0a3069 !important; background: none !important; border: none !important;}

.language-tsx .highlight .c {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-tsx .highlight .c1 {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-tsx .highlight .cm {color: #656d76 !important; font-style: italic; background: none !important; border: none !important;}

.language-tsx .highlight .m {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .mi {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .mf {color: #0969da !important; background: none !important; border: none !important;}

.language-tsx .highlight .kt {color: #0969da !important; background: none !important; border: none !important;}

.language-javascript .highlight .err {color: #116329 !important; background: none !important; border: none !important;}

.language-js .highlight .err {color: #116329 !important; background: none !important; border: none !important;}

.highlight span {background: none !important; border: none !important; box-shadow: none !important; text-decoration: none !important; outline: none !important;}

.empty-code-block {background-color: #fef6e4; color: #2e2e2e; padding: 12px; border-radius: 5px; margin: 15px 0; font-family: monospace; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}

.highlight-error {background-color: #fef6e4; color: #000080; padding: 12px; border-radius: 5px; margin: 15px 0; font-family: monospace; border: 1px solid #f0e6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}

img {max-width: 100%; height: auto;}

table {border-collapse: collapse; width: 100%;}

th {border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;}

td {border: 1px solid #ddd; padding: 8px;}

.chapter-container {background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}

.chapter-container h2 {margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #444;}

/* Estilos para el contenedor colapsable */
.collapsible-container {position: relative; overflow: hidden; transition: max-height 0.3s ease; border-radius: 8px; margin: 0;}

.collapsible-container pre {margin: 0; line-height: 1.4;}

.collapsible-container .toggle-button {position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.9); border: 1px solid #ccc; cursor: pointer; font-size: 16px; line-height: 1; padding: 4px 8px; border-radius: 4px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}

.collapsible-container .toggle-button:hover {background: rgba(255,255,255,1);}

/* Estilos para el botón de copiar */
.collapsible-container .copy-button {position: absolute; top: 8px; width: 24px; display: flex; /* Usamos flexbox para centrar el icono/texto */
  align-items: center; justify-content: center; right: 48px; /* A 40 px a la izquierda del botón de colapsar */
  background: rgba(255,255,255,0.9); border: 1px solid #ccc; cursor: pointer; font-size: 16px; line-height: 1; padding: 4px 8px; border-radius: 4px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}

.collapsible-container .copy-button:hover {background: rgba(255,255,255,1);}

.collapsible-container .fade-overlay {position: absolute; bottom: -1px; left: 0; right: 0; height: 42px; background: linear-gradient(
    to bottom, 
    rgba(255,249,229,0), 
    rgba(255,249,229,1)
  ); pointer-events: none; z-index: 5; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}

.collapsible-container .ellipsis {position: absolute; bottom: 8px; width: 100%; text-align: center; color: #888; font-size: 18px; font-weight: bold; z-index: 6;}

.collapsible-container.expanded .fade-overlay {display: none;}

.collapsible-container.expanded .ellipsis {display: none;}

/* Estilos para la tabla de contenidos */

/* Contenedor principal */
#table-of-contents {background-color: #f0f0ff; border-radius: 8px; padding: 20px 30px; margin: 20px 0; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); font-family: Arial, sans-serif; border: 1px solid #d0d0ff;}

/* Título de la tabla de contenidos */
#contents-header {text-align: center; color: #585b9e; font-size: 24px; margin-top: 10px; margin-bottom: 20px; font-weight: 500; padding-bottom: 15px;}

/* Listas */
ul.toc {list-style-type: none; padding-left: 20px; margin: 0;}

/* Elementos de la lista */
li.toc {margin: 10px 0; line-height: 1.5; color: #585b9e;}

/* Enlaces */
a.toc {text-decoration: none; color: #585b9e; transition: color 0.2s, padding-left 0.2s; display: inline-block;}

/* Efecto hover en los enlaces */
a.toc:hover {color: #3333cc; padding-left: 3px; font-weight: 500; text-decoration: none;}

/* Diferentes niveles de indentación */
li.toc li.toc {margin-left: 15px;}

li.toc li.toc li.toc {margin-left: 25px;}

/* Hacer que los enlaces de primer nivel tengan un poco más de peso */
ul.toc &gt; li.toc &gt; a.toc {font-weight: 500;}

/* Línea decorativa sobre la tabla de contenidos */
#table-of-contents:before {content: ""; display: block; height: 0px; background-color: #d0d0ff; margin-bottom: 15px;}</textarea>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
    var cssCode = document.getElementById('css-editor').value;
    var style = document.createElement('style');
    style.textContent = cssCode;
    document.head.appendChild(style);
});
  </script>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
    // Aplicar estilo con retraso de 100ms para superar posibles hojas de estilo heredadas
    setTimeout(function() {
        document.querySelectorAll('.toggle-button').forEach(btn => {
            btn.style.setProperty('color', 'black', 'important');
            if (!btn.textContent.trim()) {
                btn.textContent = '+';
            }
        });
        document.querySelectorAll('.copy-button').forEach(btn => {
            btn.style.setProperty('color', 'black', 'important');
        });
    }, 1000);
});
  </script>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
(function() {
  function initCollapsibles() {
    // Esperar un poco para que los estilos se apliquen
    setTimeout(() => {
      document.querySelectorAll('.collapsible-container').forEach(container => {
        const pre = container.querySelector('pre');
        if (!pre) return;
        
        const maxLines = parseInt(container.dataset.maxLines, 10) || 6;
        
        // Crear un elemento temporal para medir line-height
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.fontSize = getComputedStyle(pre).fontSize;
        tempSpan.style.fontFamily = getComputedStyle(pre).fontFamily;
        tempSpan.style.lineHeight = '1.4';
        tempSpan.textContent = 'M';
        document.body.appendChild(tempSpan);
        
        const lineHeight = tempSpan.offsetHeight;
        document.body.removeChild(tempSpan);
        
        const fullHeight = pre.scrollHeight;
        const collapsedHeight = Math.ceil(lineHeight * maxLines);
        
        console.log('Debug:', {
          maxLines,
          lineHeight,
          fullHeight,
          collapsedHeight,
          shouldCollapse: fullHeight > collapsedHeight + 10
        });
        
        // Solo colapsar si realmente es necesario
        if (fullHeight <= collapsedHeight + 10) {
          return;
        }

        // Estado inicial: colapsado
        container.style.maxHeight = collapsedHeight + 'px';
        container.classList.add('collapsed');

         // === Aquí agregamos primero el botón de "copiar" ===
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-button';
        copyBtn.innerHTML = '📋';
        copyBtn.title = 'Copiar código';
        container.appendChild(copyBtn);

        // Evento para copiar el texto del <pre> al portapapeles
        copyBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // Copiar el contenido de 'pre'
          const codeText = pre.innerText;
          navigator.clipboard.writeText(codeText).then(() => {
            // Opcional: retroalimentación breve (por ejemplo cambiar texto o color)
            copyBtn.textContent = '✔';
            setTimeout(() => { copyBtn.innerHTML = '📋'; }, 1000);
          }).catch(err => {
            console.error('Error al copiar al portapapeles:', err);
          });
        });

        // Crear botón
        const btn = document.createElement('button');
        btn.className = 'toggle-button';
        btn.textContent = '+';
        btn.title = 'Expandir/Colapsar código';
        container.appendChild(btn);

        // Crear overlay y ellipsis
        const overlay = document.createElement('div');
        overlay.className = 'fade-overlay';
        container.appendChild(overlay);
        
        const ell = document.createElement('div');
        ell.className = 'ellipsis';
        ell.textContent = '...';
        container.appendChild(ell);

        // Evento toggle
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const isCollapsed = container.classList.contains('collapsed');
          
          if (isCollapsed) {
            // Expandir
            container.style.maxHeight = fullHeight + 20 + 'px';
            container.classList.remove('collapsed');
            container.classList.add('expanded');
            btn.textContent = '−';
          } else {
            // Colapsar
            container.style.maxHeight = collapsedHeight + 'px';
            container.classList.add('collapsed');
            container.classList.remove('expanded');
            btn.textContent = '+';
          }
        });
      });
    }, 100); // Esperar 100ms para que se apliquen los estilos
  }
  
  // Múltiples puntos de inicialización para mayor compatibilidad
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollapsibles);
  } else {
    initCollapsibles();
  }
  
  // También inicializar en window.load por si acaso
  window.addEventListener('load', initCollapsibles);
})();
});
  </script>
 </body>
</html>
